<!-- @format -->

<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<!-- <meta name="viewport" content="width=device-width, initial-scale=1" /> -->
	<meta http-equiv="X-UA-Compatible" content="IE=11" />
	<meta name="viewport"
		content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
	<link rel="icon" href="https://nwzimg.wezhan.cn/sitefiles10167/10167896/22.png" />
	<!--[if IE 9]>
			<script src="./history.js"></script>
		<![endif]-->
	<title>Scle</title>
	<link rel="stylesheet" href="scle.css" />
	<script type="text/javascript" src="./js_min/JSZip/jszip.js"></script>

	<style>
		video {
			display: none;
		}

		.container {
			position: fixed;
			width: 100%;
			height: 100%;
			z-index: 10;
		}

		#text {
			position: absolute;
			left: 0px;
			top: 0px;
			z-index: 10;
			width: 100%;
			height: 100%;
		}

		#root {
			position: fixed;
			top: 0;
			z-index: 11;
		}
	</style>
</head>

<body>
	<div class="container">
		<canvas id="glcanvas"></canvas>
		<canvas id="text"></canvas>
	</div>

	<div id="root"></div>
</body>

</html>


<!-- http://www.featuremaker1.xyz/rs_scle/ -->
<!-- ../src/2assets/ -->

<!--
<script type="text/javascript" src="./js/SCLELoader/ADFBaseDef.js"></script>
<script type="text/javascript" src="./js/SCLELoader/ADFGeomDef.js"></script>
<script type="text/javascript" src="./js/SCLELoader/ADFSceneDef.js"></script>
<script type="text/javascript" src="./js/SCLELoader/ADFCleParser.js"></script>
<script type="text/javascript" src="./js/SCLELoader/ADFMath.js"></script>
<script type="text/javascript" src="./js/SCLELoader/ADFGlobal.js"></script>
<script type="text/javascript" src="./js/SCLELoader/ADFUSDK.js"></script>
<script type="text/javascript" src="./js/SCLERender/glmatrix.js"></script>
<script type="text/javascript" src="./js/SCLERender/GLSL.js"></script>
<script type="text/javascript" src="./js/SCLERender/Global.js"></script>
<script type="text/javascript" src="./js/SCLERender/SceneToGLData.js"></script>
<script type="text/javascript" src="./js/SCLERender/Camera.js"></script>
<script type="text/javascript" src="./js/SCLERender/GLProgram.js"></script>
<script type="text/javascript" src="./js/SCLERender/GLRunTime.js"></script>
<script type="text/javascript" src="./js/SCLERender/EventAction.js"></script>
-->

<script type="text/javascript" src="./js_min/SCLELoader/ADFBaseDef.js"></script>
<script type="text/javascript" src="./js_min/SCLELoader/ADFGeomDef.js"></script>
<script type="text/javascript" src="./js_min/SCLELoader/ADFSceneDef.js"></script>
<script type="text/javascript" src="./js_min/SCLELoader/ADFCleParser.js"></script>
<script type="text/javascript" src="./js_min/SCLELoader/ADFMath.js"></script>
<script type="text/javascript" src="./js_min/SCLELoader/ADFGlobal.js"></script>
<script type="text/javascript" src="./js_min/SCLELoader/ADFUSDK.js"></script>
<script type="text/javascript" src="./js_min/SCLERender/glmatrix.js"></script>
<script type="text/javascript" src="./js_min/SCLERender/GLSL.js"></script>
<script type="text/javascript" src="./js_min/SCLERender/Global.js"></script>
<script type="text/javascript" src="./js_min/SCLERender/SceneToGLData.js"></script>
<script type="text/javascript" src="./js_min/SCLERender/Camera.js"></script>
<script type="text/javascript" src="./js_min/SCLERender/GLProgram.js"></script>
<script type="text/javascript" src="./js_min/SCLERender/GLRunTime.js"></script>
<script type="text/javascript" src="./js_min/SCLERender/EventAction.js"></script>

<script type="text/javascript" language="javascript">
	// cle流式下载对象
	var g_sclehttp;
	// 当前下载的长度，Uint32     
	var g_loaded_pos = 0;
	var NetTimeTimeID;

	// 通过网络获取二进制数据
	getByRequest = function (url) {
		g_sclehttp = new XMLHttpRequest();
		// scle转换为zip		
		// url = url.replace('.scle', '.zip')
	
		// 为事件添加事件监听，这些事件在使用 XMLHttpRequest 执行数据传输时被发出。
		g_sclehttp.addEventListener("progress", updateProgress, false);
		g_sclehttp.addEventListener("load", transferComplete, false);
		g_sclehttp.addEventListener("error", transferFailed, false);
		g_sclehttp.addEventListener("abort", transferCanceled, false);

		g_sclehttp.open("GET", url, true);                                  // true 表示异步，false表示同步
		g_sclehttp.responseType = "arraybuffer";           // XMLHttpRequest Level 2 规范中新加入了 responseType 属性 ，使得发送和接收二进制数据变得更加容易 

		// g_sclehttp.responseType = "blob";                            
		// g_sclehttp.overrideMimeType("text/plain; charset=x-user-defined");  // XMLHttpRequest 一般用来发送和接收文本数据，overrideMimeType方法强制XMLHttpRequest发送二进制数据
		g_sclehttp.onreadystatechange = ReadcleStreamChange;
		g_sclehttp.send();
	}

	updateProgress = function (evt) {
		// progress 事件的 lengthComputable 属性存在时，可以计算数据已经传输的比例(loaded 已传输大小，total 总大小）
		if (evt.lengthComputable) {
			//  var percentComplete = evt.loaded / evt.total;
			g_nCleBufferlength = evt.total;
			g_loaded_pos = evt.loaded;
		}
		else {
		}
	}

	transferComplete = function (evt) {
		// alert("The transfer is complete.");
	}

	transferFailed = function (evt) {
		// alert("下载文件失败！");
	}

	transferCanceled = function (evt) {
		// alert("下载已取消！");
	}

	ReadcleStreamChange = function () {
		if (g_sclehttp.readyState === 4 && g_sclehttp.status === 200) { // 4 = "loaded" // 200 = OK		
			// 兼容写法
			var new_zip = new JSZip();
			new_zip.loadAsync(g_sclehttp.response).then(function (zip) {
				var key = function () {
					for (let i in zip.files) {
						return i
					}
				}
				zip.files[key()].async('arraybuffer').then(function (data) {
					g_arrayByteBuffer = data;
					g_arrayCleBuffer = new DataView(g_arrayByteBuffer, 0, g_arrayByteBuffer.byteLength);
					g_nCleBufferlength = g_arrayByteBuffer.byteLength;
					
					// 循环执行，每隔0.1秒钟执行一次
					NetTimeTimeID = window.setInterval(StarLoadNetCLEFile, 100);
				});
			});
		}
	}
	cleStreamReady= function (){} // 

	// 解析数据
	function StarLoadNetCLEFile() {
		// 去掉定时器的方法
		window.clearTimeout(NetTimeTimeID);

		// 解析cle文件
		var bResult = ParseCleStream()
		if (bResult) {
			// alert("An error occurred while transferring the file.");
		}

		// 释放内存
		g_sclehttp.response = null;
		g_arrayByteBuffer = null;
		g_arrayCleBuffer = null;
		g_sclehttp = null;

		// 绘制三维模型
		startRender();
		cleStreamReady();
	}

	var scrollFunc = function (e) {
		e = e || window.event;
		if (e.wheelDelta && event.ctrlKey) {//IE/Opera/Chrome
			event.returnValue = false;
		} else if (e.detail) {//Firefox
			event.returnValue = false;
		}
	}

	/*注册事件*/
	if (document.addEventListener) {
		document.addEventListener('DOMMouseScroll', scrollFunc, false);
	}//W3C
	window.onmousewheel = document.onmousewheel = scrollFunc;//IE/Opera/Chrome/Safari

</script>

<script src="scle.js"></script>